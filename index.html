<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Check-in Portal</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="/api/placeholder/150/50" alt="Race Logo">
            </div>
            <h1>Athlete Check-in Portal</h1>
        </header>

        <main>
            <div class="tabs">
                <button class="tab-btn active" data-tab="qr-code">
                    <i class="fas fa-qrcode"></i> QR Code Scanner
                </button>
                <button class="tab-btn" data-tab="manual">
                    <i class="fas fa-keyboard"></i> Manual Search
                </button>
                <button class="tab-btn" data-tab="status">
                    <i class="fas fa-chart-bar"></i> Race Status
                </button>
            </div>

            <div class="tab-content active" id="qr-code">
                <div class="card">
                    <h2>QR Code Check-in</h2>
                    <p>Scan athlete's QR code to quickly check them in for the race</p>
                    <div id="qr-reader"></div>
                    <button id="start-scan" class="primary-btn">
                        <i class="fas fa-camera"></i> Start Scanner
                    </button>
                </div>
            </div>

            <div class="tab-content" id="manual">
                <div class="card">
                    <h2>Manual Athlete Search</h2>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Enter bib number, phone number or athlete name">
                        <button id="search-btn" class="primary-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="search-results" class="result-box">
                        <!-- Search results will be populated here dynamically -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="status">
                <div class="card">
                    <h2>Race Check-in Dashboard</h2>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Athletes</span>
                            <span id="total-athletes" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Checked-in</span>
                            <span id="checked-in" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pending</span>
                            <span id="pending" class="stat-value">0</span>
                        </div>
                    </div>
                    <div class="recent-activity">
                        <h3>Recent Check-in Activity</h3>
                        <ul id="activity-log">
                            <!-- Activity logs will be populated here dynamically -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Athlete Details Modal -->
            <div id="athlete-modal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <div id="athlete-info">
                        <!-- Athlete info will be populated here dynamically -->
                    </div>
                    <div id="capture-photo" class="capture-box hidden">
                        <h3>Capture Athlete BIB Photo</h3>
                        <div class="camera-container">
                            <video id="camera-view" autoplay playsinline></video>
                            <canvas id="camera-canvas" class="hidden"></canvas>
                            <img id="captured-image" class="hidden">
                        </div>
                        <div class="camera-controls">
                            <button id="start-camera" class="primary-btn">
                                <i class="fas fa-camera"></i> Start Camera
                            </button>
                            <button id="capture-button" class="primary-btn" disabled>
                                <i class="fas fa-image"></i> Capture Photo
                            </button>
                            <button id="retry-capture" class="secondary-btn hidden">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="check-in-btn" class="primary-btn">
                            <i class="fas fa-check-circle"></i> Check In Athlete
                        </button>
                        <button id="take-photo-btn" class="secondary-btn">
                            <i class="fas fa-camera"></i> Take BIB Photo
                        </button>
                        <button id="cancel-btn" class="danger-btn">
                            <i class="fas fa-times-circle"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Confirmation Modal -->
            <div id="confirm-modal" class="modal">
                <div class="modal-content confirmation">
                    <span class="close-modal">&times;</span>
                    <div class="confirm-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Check-in Successful!</h2>
                    <p>Athlete has been successfully checked in for the race.</p>
                    <div class="confirm-details">
                        <p id="confirm-name"></p>
                        <p id="confirm-bib"></p>
                        <p id="confirm-category"></p>
                        <p id="confirm-time"></p>
                    </div>
                    <button id="confirm-done" class="primary-btn">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Race Management System | <a href="#" id="help-link">Help</a> | <a href="#" id="support-link">Support</a></p>
        </footer>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content help-content">
            <span class="close-modal">&times;</span>
            <h2>Help & Instructions</h2>
            <!-- Help content removed -->
        </div>
    </div>

    <script>
        // DOM Elements
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const startScanBtn = document.getElementById('start-scan');
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const athleteModal = document.getElementById('athlete-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const helpModal = document.getElementById('help-modal');
        const closeModals = document.querySelectorAll('.close-modal');
        const checkInBtn = document.getElementById('check-in-btn');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmDoneBtn = document.getElementById('confirm-done');
        const helpLink = document.getElementById('help-link');
        const capturePhoto = document.getElementById('capture-photo');
        const startCameraBtn = document.getElementById('start-camera');
        const captureButton = document.getElementById('capture-button');
        const retryCaptureBtn = document.getElementById('retry-capture');
        const cameraView = document.getElementById('camera-view');
        const cameraCanvas = document.getElementById('camera-canvas');
        const capturedImage = document.getElementById('captured-image');
        
        // Mock athlete data (would come from server API in production)
        const athletes = [
            { id: 1, name: 'Nguyễn Văn A', bib: '1001', category: 'Half Marathon - Male', phone: '0901234567', email: 'nguyenvana@gmail.com', status: 'registered' },
            { id: 2, name: 'Trần Thị B', bib: '1002', category: '10K - Female', phone: '0912345678', email: 'tranthib@gmail.com', status: 'registered' },
            { id: 3, name: 'Lê Văn C', bib: '1003', category: 'Full Marathon - Male', phone: '0923456789', email: 'levanc@gmail.com', status: 'registered' },
            { id: 4, name: 'Phạm Thị D', bib: '1004', category: '5K - Female', phone: '0934567890', email: 'phamthid@gmail.com', status: 'checked-in' },
            { id: 5, name: 'Hoàng Văn E', bib: '1005', category: '10K - Male', phone: '0945678901', email: 'hoangvane@gmail.com', status: 'checked-in' }
        ];
        
        // Tab functionality
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // Remove active class from all tabs
                tabBtns.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab
                btn.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Update dashboard stats if on status tab
                if (tabId === 'status') {
                    updateDashboardStats();
                }
            });
        });
        
        // QR Code scanner
        let html5QrCode;
        
        startScanBtn.addEventListener('click', () => {
            const qrReader = document.getElementById('qr-reader');
            
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    qrReader.innerHTML = '';
                    startScanBtn.innerHTML = '<i class="fas fa-camera"></i> Start Scanner';
                });
                return;
            }
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    // Handle QR code success - typically this would be an athlete ID
                    // For demo purposes, just showing the first athlete
                    displayAthleteModal(athletes[0]);
                    html5QrCode.stop();
                    startScanBtn.innerHTML = '<i class="fas fa-camera"></i> Start Scanner';
                },
                (errorMessage) => {
                    // QR scan error (ignored for demo)
                }
            ).catch((err) => {
                console.error(`Unable to start scanning: ${err}`);
            });
            
            startScanBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Scanner';
        });
        
        // Manual search
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        function performSearch() {
            const query = searchInput.value.toLowerCase().trim();
            
            if (!query) {
                searchResults.innerHTML = '<p class="no-results">Please enter a search term.</p>';
                return;
            }
            
            const results = athletes.filter(athlete => 
                athlete.name.toLowerCase().includes(query) || 
                athlete.bib.includes(query) || 
                athlete.phone.includes(query)
            );
            
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="no-results">No athletes found matching your search.</p>';
                return;
            }
            
            let html = '';
            results.forEach(athlete => {
                const statusClass = athlete.status === 'checked-in' ? 'checked-in' : 'registered';
                html += `
                    <div class="result-item" data-id="${athlete.id}">
                        <div class="result-main">
                            <span class="result-bib">${athlete.bib}</span>
                            <span class="result-name">${athlete.name}</span>
                        </div>
                        <div class="result-meta">
                            <span class="result-category">${athlete.category}</span>
                            <span class="result-status ${statusClass}">${athlete.status === 'checked-in' ? 'Checked-in' : 'Registered'}</span>
                        </div>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
            
            // Add click event to search results
            document.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const athleteId = parseInt(item.getAttribute('data-id'));
                    const athlete = athletes.find(a => a.id === athleteId);
                    displayAthleteModal(athlete);
                });
            });
        }
        
        // Modal handling
        function displayAthleteModal(athlete) {
            const athleteInfo = document.getElementById('athlete-info');
            const statusClass = athlete.status === 'checked-in' ? 'checked-in' : 'registered';
            
            athleteInfo.innerHTML = `
                <div class="athlete-header">
                    <span class="athlete-bib">${athlete.bib}</span>
                    <span class="athlete-status ${statusClass}">${athlete.status === 'checked-in' ? 'Checked-in' : 'Registered'}</span>
                </div>
                <h2 class="athlete-name">${athlete.name}</h2>
                <div class="athlete-details">
                    <p><strong>Category:</strong> ${athlete.category}</p>
                    <p><strong>Phone:</strong> ${athlete.phone}</p>
                    <p><strong>Email:</strong> ${athlete.email}</p>
                </div>
            `;
            
            // Update buttons based on athlete status
            if (athlete.status === 'checked-in') {
                checkInBtn.disabled = true;
                checkInBtn.innerHTML = '<i class="fas fa-check-circle"></i> Already Checked In';
            } else {
                checkInBtn.disabled = false;
                checkInBtn.innerHTML = '<i class="fas fa-check-circle"></i> Check In Athlete';
            }
            
            athleteModal.style.display = 'block';
            
            // Store athlete in modal for access by other functions
            athleteModal.setAttribute('data-athlete-id', athlete.id);
            
            // Hide capture photo section initially
            capturePhoto.classList.add('hidden');
        }
        
        // Close all modals when clicking the X
        closeModals.forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                athleteModal.style.display = 'none';
                confirmModal.style.display = 'none';
                helpModal.style.display = 'none';
                
                // Stop camera if it's running
                stopCamera();
            });
        });
        
        // Check-in button
        checkInBtn.addEventListener('click', () => {
            const athleteId = parseInt(athleteModal.getAttribute('data-athlete-id'));
            const athlete = athletes.find(a => a.id === athleteId);
            
            // Update athlete status
            athlete.status = 'checked-in';
            
            // Show confirmation modal
            document.getElementById('confirm-name').textContent = `Name: ${athlete.name}`;
            document.getElementById('confirm-bib').textContent = `BIB #: ${athlete.bib}`;
            document.getElementById('confirm-category').textContent = `Category: ${athlete.category}`;
            
            const now = new Date();
            const timeFormatted = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('confirm-time').textContent = `Time: ${timeFormatted}`;
            
            athleteModal.style.display = 'none';
            confirmModal.style.display = 'block';
            
            // Add to activity log
            addActivityLog(athlete);
            
            // Update dashboard stats if on status tab
            if (document.querySelector('.tab-btn[data-tab="status"]').classList.contains('active')) {
                updateDashboardStats();
            }
        });
        
        // Confirmation done button
        confirmDoneBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none';
        });
        
        // Camera functionality
        takePhotoBtn.addEventListener('click', () => {
            capturePhoto.classList.remove('hidden');
        });
        
        // Cancel button
        cancelBtn.addEventListener('click', () => {
            athleteModal.style.display = 'none';
            stopCamera();
        });
        
        // Start camera
        startCameraBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                
                cameraView.srcObject = stream;
                captureButton.disabled = false;
                startCameraBtn.disabled = true;
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please make sure camera permissions are granted.');
            }
        });
        
        // Capture photo
        captureButton.addEventListener('click', () => {
            // Set canvas dimensions to match video
            cameraCanvas.width = cameraView.videoWidth;
            cameraCanvas.height = cameraView.videoHeight;
            
            // Draw the video frame to the canvas
            const context = cameraCanvas.getContext('2d');
            context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);
            
            // Convert canvas to image
            capturedImage.src = cameraCanvas.toDataURL('image/png');
            
            // Show the image, hide the video
            cameraView.classList.add('hidden');
            capturedImage.classList.remove('hidden');
            retryCaptureBtn.classList.remove('hidden');
            captureButton.classList.add('hidden');
            
            // Disable start camera button
            startCameraBtn.disabled = true;
        });
        
        // Retry capture
        retryCaptureBtn.addEventListener('click', () => {
            // Show video, hide image
            cameraView.classList.remove('hidden');
            capturedImage.classList.add('hidden');
            retryCaptureBtn.classList.add('hidden');
            captureButton.classList.remove('hidden');
        });
        
        // Stop camera function
        function stopCamera() {
            if (cameraView.srcObject) {
                const tracks = cameraView.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                cameraView.srcObject = null;
            }
            
            // Reset camera UI
            captureButton.disabled = true;
            startCameraBtn.disabled = false;
            cameraView.classList.remove('hidden');
            capturedImage.classList.add('hidden');
            retryCaptureBtn.classList.add('hidden');
            captureButton.classList.remove('hidden');
        }
        
        // Help link
        helpLink.addEventListener('click', (e) => {
            e.preventDefault();
            helpModal.style.display = 'block';
        });
        
        // Add activity to the log
        function addActivityLog(athlete) {
            const activityLog = document.getElementById('activity-log');
            const now = new Date();
            const timeFormatted = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            const logItem = document.createElement('li');
            logItem.innerHTML = `
                <span class="log-time">${timeFormatted}</span>
                <span class="log-bib">#${athlete.bib}</span>
                <span class="log-name">${athlete.name}</span>
                <span class="log-action">checked in</span>
            `;
            
            // Add to beginning of list
            if (activityLog.firstChild) {
                activityLog.insertBefore(logItem, activityLog.firstChild);
            } else {
                activityLog.appendChild(logItem);
            }
            
            // Keep list to 10 items max
            if (activityLog.children.length > 10) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }
        
        // Update dashboard stats
        function updateDashboardStats() {
            const totalAthletes = athletes.length;
            const checkedIn = athletes.filter(a => a.status === 'checked-in').length;
            const pending = totalAthletes - checkedIn;
            
            document.getElementById('total-athletes').textContent = totalAthletes;
            document.getElementById('checked-in').textContent = checkedIn;
            document.getElementById('pending').textContent = pending;
        }
        
        // Initialize dashboard on page load
        updateDashboardStats();
        
        // Close modals when clicking outside modal content
        window.addEventListener('click', (e) => {
            if (e.target === athleteModal) {
                athleteModal.style.display = 'none';
                stopCamera();
            }
            if (e.target === confirmModal) {
                confirmModal.style.display = 'none';
            }
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
